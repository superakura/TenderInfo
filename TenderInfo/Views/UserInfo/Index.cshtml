
@{
    ViewBag.Title = "用户信息管理";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="~/Content/metroStyle/metroStyle.css" rel="stylesheet" />
<script src="~/Scripts/jquery.ztree.all-3.5.min.js"></script>
<div class="modal fade" id="myModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title"><span id="myTitle">添加用户信息</span>--【当前部门：<span id="deptNameModal"></span>】</h4>
                <span id="userIDModal"></span>
            </div>
            <div class="modal-body">
                <div class="nav-tabs-custom">
                    <ul class="nav nav-tabs">
                        <li class="active"><a href="#tab_1" data-toggle="tab" aria-expanded="false">基本信息</a></li>
                        <li class=""><a href="#tab_2" data-toggle="tab" aria-expanded="true">角色与管理范围</a></li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane active" id="tab_1">
                            <div class="container-fluid">
                                <div class="form-horizontal">
                                    <div class="row">
                                        <div class="col-md-5">
                                            <div class="form-group">
                                                <label for="tbxUserNum">员工编号</label>
                                                <input type="text" class="form-control" id="tbxUserNum" placeholder="员工编号">
                                            </div>
                                            <div class="form-group">
                                                <label for="tbxUserName">姓名</label>
                                                <input type="text" class="form-control" id="tbxUserName" placeholder="姓名">
                                            </div>
                                            <div class="form-group">
                                                <label for="tbxUserDuty">职务</label>
                                                <input type="text" class="form-control" id="tbxUserDuty" placeholder="职务">
                                            </div>
                                        </div>
                                        <div class="col-md-2"></div>
                                        <div class="col-md-5">
                                            <div class="form-group">
                                                <label for="tbxUserPhone">办公电话</label>
                                                <input type="text" class="form-control" id="tbxUserPhone" placeholder="办公电话">
                                            </div>
                                            <div class="form-group">
                                                <label for="tbxUserMobile">手机</label>
                                                <input type="text" class="form-control" id="tbxUserMobile" placeholder="手机">
                                            </div>
                                            <div class="form-group">
                                                <label for="tbxUserEmail">电子邮件</label>
                                                <input type="text" class="form-control" id="tbxUserEmail" placeholder="电子邮件">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="form-group">
                                                <label for="tbxUserRemark">用户备注</label>
                                                <textarea class="form-control" id="tbxUserRemark" rows="3" cols="20"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane" id="tab_2">
                            <div class="container-fluid">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="col-md-5">
                                            <h5>【管理范围】</h5>
                                            <ul class="ztree well" id="roleDeptList"></ul>
                                        </div>
                                        <div class="col-md-7">
                                            <h5>【用户角色】</h5>
                                            <table class="table table-striped table-bordered table-hover">
                                                <thead>
                                                    <tr class="success">
                                                        <th>选择</th>
                                                        <th>角色名称</th>
                                                        <th>角色描述</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="roleTableList"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" id="btnSubmit" class="btn btn-primary">提交</button>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-md-4 col-lg-3">
        <div class="box box-primary">
            <div class="box-header">
                <h3 class="box-title">部门列表</h3>
                <div class="box-tools pull-right">
                    <button type="button" class="btn btn-box-tool" data-widget="collapse" data-toggle="tooltip" title="" data-original-title="collapse">
                        <i class="fa fa-minus"></i>
                    </button>
                </div>
            </div>
            <div class="box-body">
                <iframe style="width:100%;border:none;height:600px;" src="/Dept/iFrameDeptTree" id="iFrameLeftDept" name="LeftDept"></iframe>
            </div>
        </div>
    </div>
    <div class="col-md-8 col-lg-9">
        <div class="box box-danger">
            <div class="box-header">
                <h3 class="box-title">用户信息管理【当前部门：<span id="selectDept"></span><span class="hidden" id="selectDeptID"></span>】</h3>
                <div class="box-tools pull-right">
                    <button type="button" class="btn btn-box-tool" data-widget="collapse" data-toggle="tooltip" title="" data-original-title="collapse">
                        <i class="fa fa-minus"></i>
                    </button>
                </div>
            </div>
            <div class="box-body">
                <div class="row">
                    <div class="col-lg-12">
                        <form class="form-inline" role="form">
                            <div class="form-group">
                                <label>用户姓名：</label>
                                <input type="text" class="form-control" id="tbxUserNameSearch" placeholder="用户姓名">
                            </div>
                            <div class="form-group">
                                <label for="tbxUserNum">员工编号：</label>
                                <input type="text" class="form-control" id="tbxUserNumSearch" placeholder="员工编号">
                            </div>
                            <button type="button" id="btnSearch" class="btn btn-primary">
                                <span class="glyphicon glyphicon-search"></span> 查询
                            </button>
                        </form>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div id="toolbar" class="btn-group">
                            <button id="btnAdd" type="button" class="btn btn-info">
                                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> 新增
                            </button>
                            <button id="btnDelSelect" type="button" class="btn btn-danger">
                                <span class="glyphicon glyphicon-remove" aria-hidden="true"></span> 删除
                            </button>
                            <button id="btnExport" type="button" class="btn btn-default">
                                <span class="glyphicon glyphicon-export" aria-hidden="true"></span> 数据导出
                            </button>
                        </div>
                        <table id="bsTable"></table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    $(function () {
        //加载部门信息
        var setting = {
            data: {
                simpleData: {
                    enable: true
                }
            },
            callback: {
                onClick: zTreeOnClick
            },
            check: {
                enable: true,
                chkDisabledInherit: false,
                nocheckInherit: false
            }
        };
        function zTreeOnClick(event, treeId, treeNode) {
            
        };
        function LoadDeptList(ele, set) {
            $("#roleDeptList").remove("li");
            $.ajax({
                url: "/Dept/LoadDeptList",
                cache: false,
                dataType: "json",
                success: function (result) {
                    $.fn.zTree.init($(ele), set, result);
                }
            });
        };

        //iframe部门列表中，点击部门查看人员事件定义
        window.onTreeClick = function () {
            $("#bsTable").bootstrapTable('refresh');
        }

        //设置修改和删除用户操作
        var operateEvents = {
            'click .edit': function (e, value, row, index) {
                $('#myModal').modal('show');
                $("#myTitle").text("编辑用户信息");
                $("#userIDModal").text(row.UserID);
                var args = { "userID": row.UserID };
                getRoleList();
                LoadDeptList("#roleDeptList", setting);
                $.post("/UserInfo/GetOne", encodeURIComponent(JSON.stringify(args)), function (result) {
                    var userInfo = result["userInfo"];
                    var roleInfo = result["userRole"];
                    var deptControlInfo = result["userDept"];

                    $("#tbxUserName").val(userInfo[0]["UserName"]);
                    $("#tbxUserNum").val(userInfo[0]["UserNum"]).attr("disabled", "disabled");
                    $("#tbxUserDuty").val(userInfo[0]["UserDuty"]);
                    $("#tbxUserPhone").val(userInfo[0]["UserPhone"]);
                    $("#tbxUserMobile").val(userInfo[0]["UserMobile"]);
                    $("#tbxUserEmail").val(userInfo[0]["UserEmail"]);
                    $("#tbxUserRemark").val(userInfo[0]["UserRemark"]);

                    $.each(roleInfo, function (index, val) {
                        $("input:checkbox[name='cbxRole'][value=" + val["RoleID"] + "]").attr("checked", "checked");
                    });
                    
                    var treeObj = $.fn.zTree.getZTreeObj("roleDeptList");
                    for (var i = 0; i < deptControlInfo.length; i++) {
                        var node = treeObj.getNodeByParam("id", deptControlInfo[i]["DeptID"], null);
                        treeObj.checkNode(node, true, false);
                    }
                });
            },
            'click .remove': function (e, value, row, index) {
                Ewin.confirm({ message: "确认要删除【" + row.UserNum + " | " + row.UserName + "】吗？" }).on(function (e) {
                    if (!e) {
                        return;
                    }
                    //写服务器后台删除方法,成功后执行页面删除数据
                    var args = { "userID": row.UserID };
                    $.post("/UserInfo/Del", encodeURIComponent(JSON.stringify(args)), function (result) {
                        if (result == "ok") {
                            //后台删除成功后，调用前台删除方法
                            $('#bsTable').bootstrapTable('remove', {
                                field: 'UserID',
                                values: [row.UserID]
                            });
                            toastr.success("删除【" + row.UserName + "】成功！", "提示")
                        }
                        else {
                            toastr.error("保存错误，请联系5613877！", "提示");
                        }
                    });

                });
            }
        };
        function operateFormatter(value, row, index) {
            return [
                '<a class="edit" href="javascript:void(0)" title="edit">',
                '<i class="glyphicon glyphicon-pencil"></i>',
                '</a>  ',
                '<a class="remove" href="javascript:void(0)" title="Remove">',
                '<i class="glyphicon glyphicon-trash"></i>',
                '</a>'
            ].join('&nbsp;&nbsp;');
        }

        //设置表格列信息
        var columns = [
            {
                checkbox: true
            },
            {
                field: 'UserID',
                title: 'ID编号'
            },
            {
                field: 'UserNum',
                title: '员工编号'
            },
            {
                field: 'UserName',
                title: '用户姓名'
            },
            {
                field: 'fatherDeptName',
                title: '二级单位'
            },
            {
                field: 'DeptName',
                title: '部门名称'
            },
            {
                field: 'UserPhone',
                title: '办公电话'
            },
            {
                field: 'UserMobile',
                title: '手机'
            },
            {
                field: 'UserDuty',
                title: '用户职务'
            },
            {
                field: 'UserEmail',
                title: '电子邮件'
            },
            {
                field: 'operate',
                title: '编辑&删除',
                align: 'center',
                events: operateEvents,
                formatter: operateFormatter
            }];

        //设置查询参数
        var queryParams = function (params) {
            var temp = {   //这里的键的名字和控制器的变量名必须一直，这边改动，控制器也需要改成一样的
                limit: params.limit,   //页面大小
                offset: params.offset,  //页码
                userName: $("#tbxUserNameSearch").val(),
                deptID: $("#selectDeptID").text(),
                userNum: $("#tbxUserNumSearch").val()
            };
            return temp;
        };

        //设置bs-table
        $('#bsTable').bootstrapTable({
            url: '/UserInfo/GetList',         //请求后台的URL（*）
            contentType: 'application/x-www-form-urlencoded',
            method: 'post',                     //请求方式（*）
            toolbar: '#toolbar',                //工具按钮用哪个容器
            striped: true,                      //是否显示行间隔色
            cache: false,                       //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
            pagination: true,                   //是否显示分页（*）
            sortable: false,                     //是否启用排序
            sortOrder: "asc",                   //排序方式
            queryParams: queryParams,//传递参数（*）
            sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
            pageNumber: 1,                       //初始化加载第一页，默认第一页
            pageSize: 10,                       //每页的记录行数（*）
            pageList: [10, 15, 20, 25],        //可供选择的每页的行数（*）
            search: false,                       //是否显示表格搜索，此搜索是客户端搜索，不会进服务端，所以，个人感觉意义不大
            strictSearch: true,
            showColumns: true,                  //是否显示所有的列
            showRefresh: true,                  //是否显示刷新按钮
            minimumCountColumns: 2,             //最少允许的列数
            clickToSelect: false,                //是否启用点击选中行
            //height: 600,                        //行高，如果没有设置height属性，表格自动根据记录条数觉得表格高度
            uniqueId: "UserID",                     //每一行的唯一标识，一般为主键列
            showToggle: false,                    //是否显示详细视图和列表视图的切换按钮
            cardView: false,                    //是否显示详细视图
            detailView: false,                   //是否显示父子表
            paginationPreText: "上一页",
            paginationNextText: "下一页",
            showExport: false,                     //是否显示导出
            columns: columns
        });

        //获取用户添加/修改表单中用户所拥有权限的信息
        function getRoleList() {
            $.post("/RoleInfo/GetListForUser", function (result) {
                var temp = "";
                $.each(result, function (index, val) {
                    temp += "<tr><td><input name='cbxRole' id='" + val["RoleID"] + "' type='checkbox' value='" + val["RoleID"] + "' /></td>";
                    temp += "<td>" + val["RoleName"] + "</td>";
                    temp += "<td>" + val["RoleDescribe"] + "</td>";
                    temp += "</tr>";
                });
                $("#roleTableList").empty().append(temp);
            });
        }

        //搜索按钮
        $("#btnSearch").click(function () {
            $("#bsTable").bootstrapTable('refresh');
        });

        //添加用户按钮
        $("#btnAdd").click(function () {
            var deptInfo = $("#selectDept").text();
            if (deptInfo == "") {
                toastr.error("请先选择员工所属的部门", "提示");
            }
            else {
                clearInfo();
                $('#myModal').modal('show');
                $("#myTitle").text("新增用户");
                $("#tbxUserNum").attr("disabled", false);
                $("#deptNameModal").text(deptInfo);
                getRoleList();
                LoadDeptList("#roleDeptList", setting);
            }
        });

        //清理用户添加/修改表单
        function clearInfo() {
            $("#tab_1 input").val("");
            $("#tab_1 textarea").val("");
            $("#userIDModal").text("");
            $("label.error").hide();
            $(".error").removeClass("error");
        }

        //获取模拟框中，选择部门的信息
        function getTreeChecked() {
            var newsDeliver = {};
            var treeObj = $.fn.zTree.getZTreeObj("roleDeptList");
            var nodesInfo = treeObj.getCheckedNodes(true);
            for (var i = 0; i < nodesInfo.length; i++) {
                newsDeliver[i] += JSON.stringify(nodesInfo[i]["id"]);
            }
            return JSON.stringify(newsDeliver).replace(/undefined/g, "")
        }

        //提交按钮
        $("#btnSubmit").click(function () {
            //获取用户的基本信息
            var userNum = $("#tbxUserNum").val();
            var userName = $("#tbxUserName").val();
            var userDuty = $("#tbxUserDuty").val();
            var userPhone = $("#tbxUserPhone").val();
            var userMobile = $("#tbxUserMobile").val();
            var userEmail = $("#tbxUserEmail").val();
            var userRemark = $("#tbxUserRemark").val();

            //获取用户所能管理的部门
            var deptList = getTreeChecked();

            //获取用户所用户的角色信息
            var roleList = {};
            $("input:checkbox[name='cbxRole']:checked").each(function (index, val) {
                roleList[index] = $(this).val();
            });

            //判断是添加操作还是修改操作
            if ($("#userIDModal").text() != "") {
                Ewin.confirm({ message: "确认要修改用户【" + userName + "】吗？" }).on(function (e) {
                    if (!e) {
                        return;
                    }
                    else {
                        //不能修改用户的员工编号信息，不能修改用户所在的单位。
                        //修改单位单独用员工调动功能实现
                        var args = {
                            "userID": $("#userIDModal").text(),
                            "userName": userName,
                            "userDuty": userDuty,
                            "userPhone": userPhone,
                            "userMobile": userMobile,
                            "userEmail": userEmail,
                            "userRemark": userRemark,
                            "roleList": roleList,
                            "deptList": deptList
                        };
                        $.post("/UserInfo/Update", encodeURIComponent(JSON.stringify(args)), function (result) {
                            if (result == "ok") {
                                $("#myModal").modal("hide");
                                toastr["success"]("修改用户【" + userName + "】成功", "提示");
                                $("#bsTable").bootstrapTable('refresh');
                            }
                            else {
                                $("#myModal").modal("hide");
                                toastr["error"](result, "提示");
                            }
                        });
                    }
                });
            }
            else {
                Ewin.confirm({ message: "确认要增加用户【" + userName + "】吗？" }).on(function (e) {
                    if (!e) {
                        return;
                    }
                    else {
                        var deptID = $("#selectDeptID").text();//用户信息管理--当前部门隐藏ID

                        var args = {
                            "userName": userName,
                            "userNum": userNum,
                            "userDuty": userDuty,
                            "userPhone": userPhone,
                            "userMobile": userMobile,
                            "userEmail": userEmail,
                            "userRemark": userRemark,
                            "deptID": deptID,
                            "roleList": roleList,
                            "deptList": deptList
                        };
                        $.post("/UserInfo/Insert", encodeURIComponent(JSON.stringify(args)), function (result) {
                            if (result == "ok") {
                                $("#myModal").modal("hide");
                                toastr["success"]("添加用户【" + userName + "】成功", "提示");
                                $("#bsTable").bootstrapTable('refresh');
                            }
                            else {
                                $("#myModal").modal("hide");
                                toastr["error"]("保存错误：" + result, "提示");
                            }
                        });
                    }
                });
            }
        });
    });
</script>


